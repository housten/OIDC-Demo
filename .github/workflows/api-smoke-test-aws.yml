name: AWS API Smoke Test

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy Lambda (OIDC)"]
    types:
      - completed

env:
  REGION: eu-north-1
  GITHUB_AUDIENCE: metrics-api
  API_URL: https://k6opu4nrel.execute-api.eu-north-1.amazonaws.com

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get install -y jq

      - name: Get GitHub OIDC token for API
        id: gh-oidc
        env:
          GITHUB_AUDIENCE: ${{ env.GITHUB_AUDIENCE }}
        run: |
          echo "Requesting GitHub OIDC token with audience=${GITHUB_AUDIENCE}..."
          RESPONSE=$(curl -sSL \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${GITHUB_AUDIENCE}")
          echo "$RESPONSE" | jq .
          TOKEN=$(echo "$RESPONSE" | jq -r '.value')
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to obtain GitHub OIDC token"
            exit 1
          fi
          echo "ACCESS_TOKEN=$TOKEN" >> "$GITHUB_ENV"

      - name: Submit sample test result (write)
        id: submit
        env:
          API_URL: ${{ env.API_URL }}
        run: |
          echo "Submitting test result to ${API_URL}..."
          payload=$(jq -n \
            --arg buildId "build-${GITHUB_RUN_ID}" \
            --arg testName "smoke-test-${GITHUB_RUN_NUMBER}" \
            --arg outcome "Passed" \
            --argjson durationSeconds 1.5 \
            '{buildId:$buildId,testName:$testName,outcome:$outcome,durationSeconds:$durationSeconds}')
          RESPONSE=$(curl -s -i -X POST \
            "${API_URL}/api/testresults/result" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$payload")
          echo "$RESPONSE"
          STATUS=$(echo "$RESPONSE" | head -n 1 | awk '{print $2}')
          if [ "$STATUS" != "202" ]; then
            echo "Expected 202, got $STATUS"
            exit 1
          fi
          echo "Submit OK (202)"

      - name: Fetch metrics summary (read)
        id: summary
        env:
          API_URL: ${{ env.API_URL }}
        run: |
          echo "Fetching summary from ${API_URL}..."
          RESPONSE=$(curl -s -i -X GET \
            "${API_URL}/api/testresults/summary" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}")
          echo "$RESPONSE"
          STATUS=$(echo "$RESPONSE" | head -n 1 | awk '{print $2}')
          if [ "$STATUS" != "200" ]; then
            echo "Expected 200, got $STATUS"
            exit 1
          fi
          echo "Summary OK (200)"
      - name: Clear test data (write operation)
        if: false  # Disabled to preserve demo data
        id: clear
        run: |
          echo "ðŸ—‘ï¸ Clearing test data..."
          
          python3 sign_request.py \
            "${FUNCTION_URL}api/testresults/clear" \
            POST
          
          status=$(cat response.json | jq -r '.status_code')
          
          if [ "$status" != "202" ]; then
            echo "âŒ Clear failed"
            exit 1
          fi
          
          echo "âœ… Clear successful (202 Accepted)"
      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ§ª AWS API Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** \`${API_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Auth:** GitHub OIDC (issuer: token.actions.githubusercontent.com, audience: metrics-api)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Submit Result | ${{ steps.submit.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fetch Summary | ${{ steps.summary.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY


