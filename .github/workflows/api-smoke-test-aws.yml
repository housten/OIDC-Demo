name: AWS API Smoke Test

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy Lambda (OIDC)"]
    types:
      - completed

env:
  REGION: eu-north-1
  FUNCTION_NAME: metrics-api-lambda
  FUNCTION_URL: https://ginqh6vfhuokxidskdt2df7xxq0cqpjq.lambda-url.eu-north-1.on.aws

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::140977286959:role/GitHubActionsOIDC-Lambda-Deployer
          aws-region: ${{ env.REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Submit sample test result (write operation)
        id: submit
        run: |
          # Create payload
          cat > event.json <<EOF
          {
            "version": "2.0",
            "routeKey": "POST /api/testresults/result",
            "rawPath": "/api/testresults/result",
            "requestContext": {
              "http": {
                "method": "POST",
                "path": "/api/testresults/result"
              },
              "invokedFunctionArn": "arn:aws:lambda:${{ env.REGION }}:140977286959:function:${{ env.FUNCTION_NAME }}"
            },
            "headers": {
              "content-type": "application/json"
            },
            "body": "{\"buildId\":\"build-${{ github.run_id }}\",\"testName\":\"smoke-test-${{ github.run_number }}\",\"outcome\":\"Passed\",\"durationSeconds\":1.5}"
          }
          EOF
          
          # Invoke Lambda directly
          aws lambda invoke \
            --function-name ${{ env.FUNCTION_NAME }} \
            --payload file://event.json \
            --cli-binary-format raw-in-base64-out \
            response.json
          
          echo "Response:"
          cat response.json | jq '.'
          
          # Parse Lambda response (contains statusCode in body)
          status_code=$(cat response.json | jq -r '.statusCode // empty')
          
          if [ "$status_code" != "202" ]; then
            echo "âŒ Expected HTTP 202, got $status_code"
            cat response.json
            exit 1
          fi
          
          echo "âœ… Submit successful"

      - name: Fetch metrics summary (read operation)
        id: summary
        run: |
          cat > event.json <<EOF
          {
            "version": "2.0",
            "routeKey": "GET /api/testresults/summary",
            "rawPath": "/api/testresults/summary",
            "requestContext": {
              "http": {
                "method": "GET",
                "path": "/api/testresults/summary"
              },
              "invokedFunctionArn": "arn:aws:lambda:${{ env.REGION }}:140977286959:function:${{ env.FUNCTION_NAME }}"
            }
          }
          EOF
          
          aws lambda invoke \
            --function-name ${{ env.FUNCTION_NAME }} \
            --payload file://event.json \
            --cli-binary-format raw-in-base64-out \
            summary.json
          
          echo "Summary response:"
          cat summary.json | jq '.'
          
          status_code=$(cat summary.json | jq -r '.statusCode // empty')
          
          if [ "$status_code" != "200" ]; then
            echo "âŒ Expected HTTP 200, got $status_code"
            exit 1
          fi
          
          echo "âœ… Summary fetch successful"

      - name: Clear test data (write operation)
        if: false  # Disabled to preserve data
        id: clear
        run: |
          cat > event.json <<EOF
          {
            "version": "2.0",
            "routeKey": "POST /api/testresults/clear",
            "rawPath": "/api/testresults/clear",
            "requestContext": {
              "http": {
                "method": "POST",
                "path": "/api/testresults/clear"
              },
              "invokedFunctionArn": "arn:aws:lambda:${{ env.REGION }}:140977286959:function:${{ env.FUNCTION_NAME }}"
            }
          }
          EOF
          
          aws lambda invoke \
            --function-name ${{ env.FUNCTION_NAME }} \
            --payload file://event.json \
            --cli-binary-format raw-in-base64-out \
            clear.json
          
          status_code=$(cat clear.json | jq -r '.statusCode // empty')
          
          if [ "$status_code" != "202" ]; then
            echo "âŒ Clear failed"
            exit 1
          fi
          
          echo "âœ… Clear successful"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: |
            event.json
            response.json
            summary.json
            clear.json
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ§ª AWS API Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function:** \`${{ env.FUNCTION_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Authentication:** AWS IAM (Direct Invoke) - No secrets required âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Submit Result | ${{ steps.submit.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fetch Summary | ${{ steps.summary.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clear Data | ${{ steps.clear.outcome == '' && 'skipped' || steps.clear.outcome }} |" >> $GITHUB_STEP_SUMMARY