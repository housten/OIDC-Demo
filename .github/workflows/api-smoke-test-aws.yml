name: AWS API Smoke Test

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy Lambda (OIDC)"]
    types:
      - completed

env:
  REGION: eu-north-1
  FUNCTION_NAME: metrics-api-lambda
  FUNCTION_URL: https://ginqh6vfhuokxidskdt2df7xxq0cqpjq.lambda-url.eu-north-1.on.aws/

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::140977286959:role/GitHubActionsOIDC-Lambda-Deployer
          aws-region: ${{ env.REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Install dependencies
        run: |
          pip install boto3 requests requests-aws4auth

      - name: Create signing helper script
        run: |
          cat > sign_request.py <<'EOF'
          import sys, json, os
          from requests_aws4auth import AWS4Auth
          import boto3, requests
          
          # Get credentials from environment (set by configure-aws-credentials action)
          session = boto3.Session()
          credentials = session.get_credentials()
          
          # Create AWS Signature V4 auth
          auth = AWS4Auth(
              credentials.access_key,
              credentials.secret_key,
              os.environ.get('AWS_REGION', 'eu-north-1'),
              'lambda',
              session_token=credentials.token
          )
          
          # Parse arguments
          url = sys.argv[1]
          method = sys.argv[2]
          payload = sys.argv[3] if len(sys.argv) > 3 else None
          
          # Make signed request
          headers = {'Content-Type': 'application/json'}
          response = requests.request(
              method=method,
              url=url,
              auth=auth,
              headers=headers,
              data=payload
          )
          
          # Output results
          print(f"HTTP Status: {response.status_code}")
          print(f"Headers: {dict(response.headers)}")
          print(f"Body: {response.text}")
          
          # Save for parsing
          result = {
              "status_code": response.status_code,
              "body": response.text,
              "headers": dict(response.headers)
          }
          with open('response.json', 'w') as f:
              json.dump(result, f, indent=2)
          
          # Exit with success/failure
          sys.exit(0 if response.status_code in [200, 202] else 1)
          EOF

      - name: Submit sample test result (write operation)
        id: submit
        run: |
          echo "ðŸ“¤ Submitting test result..."
          
          payload='{"buildId":"build-${{ github.run_id }}","testName":"smoke-test-${{ github.run_number }}","outcome":"Passed","durationSeconds":1.5}'
          
          python3 sign_request.py \
            "${FUNCTION_URL}api/testresults/result" \
            POST \
            "$payload"
          
          status=$(cat response.json | jq -r '.status_code')
          
          if [ "$status" != "202" ]; then
            echo "âŒ Expected 202, got $status"
            cat response.json | jq '.'
            exit 1
          fi
          
          echo "âœ… Submit successful (202 Accepted)"

      - name: Fetch metrics summary (read operation)
        id: summary
        run: |
          echo "ðŸ“Š Fetching summary..."
          
          python3 sign_request.py \
            "${FUNCTION_URL}api/testresults/summary" \
            GET
          
          status=$(cat response.json | jq -r '.status_code')
          
          if [ "$status" != "200" ]; then
            echo "âŒ Expected 200, got $status"
            cat response.json | jq '.'
            exit 1
          fi
          
          echo "âœ… Summary fetch successful (200 OK)"
          echo ""
          echo "Summary data:"
          cat response.json | jq -r '.body' | jq '.'

      - name: Clear test data (write operation)
        if: false  # Disabled to preserve demo data
        id: clear
        run: |
          echo "ðŸ—‘ï¸ Clearing test data..."
          
          python3 sign_request.py \
            "${FUNCTION_URL}api/testresults/clear" \
            POST
          
          status=$(cat response.json | jq -r '.status_code')
          
          if [ "$status" != "202" ]; then
            echo "âŒ Clear failed"
            exit 1
          fi
          
          echo "âœ… Clear successful (202 Accepted)"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: |
            sign_request.py
            response.json
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ§ª AWS API Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function URL:** \`${FUNCTION_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Authentication:** AWS IAM SigV4 (via GitHub OIDC) - No secrets required âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Submit Result | ${{ steps.submit.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fetch Summary | ${{ steps.summary.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clear Data | ${{ steps.clear.outcome == '' && 'â­ï¸ Skipped' || steps.clear.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Security Features Demonstrated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Zero secrets stored in GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Temporary credentials (1-hour expiry)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… IAM role assumption via OIDC federation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AWS Signature V4 request signing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Least-privilege IAM policy" >> $GITHUB_STEP_SUMMARY